// ============ ParentComponent.jsx ============
import React, { useEffect } from 'react';
import EnterTableListUI from './EnterTableListUI';
import Payment from './Payment';
import Signature from './Signature';
import useTableStore from './store/useTableStore';

function ParentComponent() {
  // 订阅 store
  const getTableData = useTableStore(state => state.getTableData);
  const getSubmitData = useTableStore(state => state.getSubmitData);
  const validateAll = useTableStore(state => state.validateAll);
  const markAsSaved = useTableStore(state => state.markAsSaved);
  const hasUnsavedChanges = useTableStore(state => state.hasUnsavedChanges);
  const initializeTable = useTableStore(state => state.initializeTable);

  // 初始化数据
  useEffect(() => {
    // 从接口获取初始数据
    const fetchData = async () => {
      try {
        // const response = await fetch('/api/table-data');
        // const { dataList, headerConfig, footerData } = await response.json();
        
        // Mock 数据示例
        const mockData = [
          [
            { uuid: '1-0', rowIndex: 0, columnIndex: 0, key: 'name', value: '商品A', type: 'input', required: true },
            { uuid: '1-1', rowIndex: 0, columnIndex: 1, key: 'amount', value: '100', type: 'input', format: 'money' },
            { uuid: '1-2', rowIndex: 0, columnIndex: 2, key: 'category', value: 'A', type: 'select', options: [
              { value: 'A', label: '分类A' },
              { value: 'B', label: '分类B' }
            ]}
          ]
        ];
        
        const headerConfig = {
          showIndex: true,
          titleIndex: '序号',
          showRowSpan: 1,
          theadList: [
            {
              id: 'header-1',
              rowList: [
                { id: 'col-1', title: '名称', key: 'name', type: 'input', required: true },
                { id: 'col-2', title: '金额', key: 'amount', type: 'input', format: 'money' },
                { id: 'col-3', title: '分类', key: 'category', type: 'select' }
              ]
            }
          ]
        };
        
        const footerData = [
          { id: 'footer-1', title: '合计', value: '', colSpan: 2 },
          { id: 'footer-2', title: '', value: '0.00', key: 'total' }
        ];
        
        initializeTable(mockData, headerConfig, footerData);
      } catch (error) {
        console.error('初始化失败', error);
      }
    };
    
    fetchData();
  }, [initializeTable]);

  // 保存（草稿）
  const handleSave = async () => {
    const tableData = getTableData();
    
    try {
      // await fetch('/api/save-draft', {
      //   method: 'POST',
      //   headers: { 'Content-Type': 'application/json' },
      //   body: JSON.stringify(tableData)
      // });
      
      console.log('[保存草稿]', tableData);
      markAsSaved();
      alert('保存成功！');
    } catch (error) {
      console.error('保存失败', error);
      alert('保存失败！');
    }
  };

  // 提交
  const handleSubmit = async () => {
    // 先验证
    const validation = validateAll();
    if (!validation.valid) {
      alert(`请填写以下必填项：\n${validation.errors.map(e => e.message).join('\n')}`);
      return;
    }
    
    const submitData = getSubmitData();
    
    try {
      // await fetch('/api/submit', {
      //   method: 'POST',
      //   headers: { 'Content-Type': 'application/json' },
      //   body: JSON.stringify(submitData)
      // });
      
      console.log('[提交数据]', submitData);
      markAsSaved();
      alert('提交成功！');
    } catch (error) {
      console.error('提交失败', error);
      alert('提交失败！');
    }
  };

  // 离开页面提示
  useEffect(() => {
    const handleBeforeUnload = (e) => {
      if (hasUnsavedChanges) {
        e.preventDefault();
        e.returnValue = '有未保存的更改，确定要离开吗？';
      }
    };
    
    window.addEventListener('beforeunload', handleBeforeUnload);
    return () => window.removeEventListener('beforeunload', handleBeforeUnload);
  }, [hasUnsavedChanges]);

  return (
    <div>
      <EnterTableListUI />
      <Payment />
      <Signature />
      <div>
        <button onClick={handleSave} disabled={!hasUnsavedChanges}>
          保存 {hasUnsavedChanges && '●'}
        </button>
        <button onClick={handleSubmit}>
          提交
        </button>
      </div>
    </div>
  );
}

export default ParentComponent;

*********************************************************

// ============ EnterTableListUI.jsx ============
import React, { useCallback } from 'react';
import TableRow from './TableRow';
import useTableStore from './store/useTableStore';
import style from './style.module.css';

function EnterTableListUI() {
  // 订阅 store
  const dataList = useTableStore(state => state.dataList);
  const footerState = useTableStore(state => state.footerState);
  const tbHeaderArg = useTableStore(state => state.tbHeaderArg);
  const versionCheckedInfor = useTableStore(state => state.versionCheckedInfor);
  
  // 订阅操作方法
  const insertRow = useTableStore(state => state.insertRow);
  const insertZeroRow = useTableStore(state => state.insertZeroRow);
  const deleteRow = useTableStore(state => state.deleteRow);
  const updateCellValue = useTableStore(state => state.updateCellValue);
  const updateCellProps = useTableStore(state => state.updateCellProps);
  const setVersionError = useTableStore(state => state.setVersionError);
  const setVersionCheck = useTableStore(state => state.setVersionCheck);
  const recalculateFooter = useTableStore(state => state.recalculateFooter);

  // ==================== 事件处理器 ====================
  
  const handleInsertZeroRow = useCallback(() => {
    insertZeroRow();
  }, [insertZeroRow]);

  const handleInsertRow = useCallback((rowIndex) => {
    insertRow(rowIndex);
  }, [insertRow]);

  const handleDeleteRow = useCallback((rowIndex) => {
    if (window.confirm('确定要删除这一行吗？')) {
      deleteRow(rowIndex);
      recalculateFooter(); // 删除后重新计算页脚
    }
  }, [deleteRow, recalculateFooter]);

  const handleInputChange = useCallback((e, item, rowIndex, columnIndex) => {
    const value = e.target.value;
    updateCellValue(rowIndex, columnIndex, value);
    
    // 如果是金额字段，触发页脚重新计算
    if (item.format === 'money') {
      recalculateFooter();
    }
  }, [updateCellValue, recalculateFooter]);

  const handleSelectChange = useCallback((e, item, rowIndex, columnIndex) => {
    const value = e.target.value;
    updateCellValue(rowIndex, columnIndex, value);
  }, [updateCellValue]);

  const handleInputFocus = useCallback((e, item, rowIndex, columnIndex) => {
    // 聚焦时的逻辑（如选中文本）
    e.target.select();
  }, []);

  const handleInputBlur = useCallback((e, item, rowIndex, columnIndex) => {
    // 失焦时的验证逻辑
    const value = e.target.value;
    
    if (item.required && !value) {
      updateCellProps(rowIndex, columnIndex, { valueError: true });
    }
  }, [updateCellProps]);

  const handleInputKeydown = useCallback((e, item, rowIndex, columnIndex) => {
    // Enter 键跳转到下一个输入框
    if (e.key === 'Enter') {
      e.preventDefault();
      const nextInput = document.querySelector(
        `[name="${item.key}"][data-testid="${item.key}-${rowIndex + 1}"]`
      );
      nextInput?.focus();
    }
  }, []);

  const handleSelectFocus = useCallback((e, item, rowIndex, columnIndex) => {
    // select 聚焦逻辑
  }, []);

  const handleSelectClick = useCallback((e, item, rowIndex, columnIndex) => {
    // select 点击逻辑
  }, []);

  const handleSelectMouseDown = useCallback((e) => {
    // select 鼠标按下逻辑
  }, []);

  const handleVersionClick = useCallback((e, item) => {
    // 版本选择点击
    const { rowIndex, columnIndex, versionList } = item;
    const selectedVersion = e.target.textContent;
    
    // 更新值并标记已校验
    updateCellValue(rowIndex, columnIndex, selectedVersion);
    setVersionError(rowIndex, columnIndex, false, []);
    setVersionCheck(rowIndex, columnIndex, 1);
  }, [updateCellValue, setVersionError, setVersionCheck]);

  // 输入框注册（用于焦点管理）
  const inputRefs = React.useRef({});
  const registerInput = useCallback((key) => {
    return (el) => {
      if (el) {
        inputRefs.current[key] = el;
      }
    };
  }, []);

  if (!tbHeaderArg) {
    return <div>加载中...</div>;
  }

  // ==================== Render ====================
  return (
    <div className={style.tbContainer}>
      <div className={style.table_list_style}>
        {/* Header */}
        <div className={style.gridHeader}>
          {tbHeaderArg?.theadList?.map((rowItem, rowIndex) => (
            <React.Fragment key={rowItem.id}>
              {tbHeaderArg.showIndex && rowIndex === 0 && (
                <div
                  key={rowItem.id + '_index'}
                  className={`${style.selfTh} ${style.gridCell}`}
                  style={{ 
                    gridRow: `1 / ${tbHeaderArg.showRowSpan + 1}`,
                    gridColumn: '1'
                  }}
                >
                  <div className={style.operation_btn_wrapper}>
                    <button
                      className={`${style.operation_btn} ${style.header_add_btn}`}
                      onClick={handleInsertZeroRow}
                    >
                      +
                    </button>
                    <span>{tbHeaderArg.titleIndex}</span>
                  </div>
                </div>
              )}
              {rowItem.rowList.map((colItem) => (
                <div
                  key={colItem.id}
                  className={`${style.selfTh} ${style.gridCell}`}
                  style={{
                    gridRow: colItem.rowSpan > 1 
                      ? `${rowIndex + 1} / span ${colItem.rowSpan}` 
                      : `${rowIndex + 1}`,
                    gridColumn: colItem.colSpan > 1 
                      ? `span ${colItem.colSpan}` 
                      : 'auto'
                  }}
                >
                  {colItem.title}
                </div>
              ))}
            </React.Fragment>
          ))}
        </div>

        {/* Body */}
        <div className={style.gridBody}>
          {dataList.map((rowItem, rowIndex) => (
            <TableRow
              key={rowItem[0].uuid}
              rowItem={rowItem}
              rowIndex={rowIndex}
              tbHeaderArg={tbHeaderArg}
              versionCheckedInfor={versionCheckedInfor}
              registerInput={registerInput}
              onInsertRow={handleInsertRow}
              onDeleteRow={handleDeleteRow}
              onInputChange={handleInputChange}
              onSelectFocus={handleSelectFocus}
              onSelectChange={handleSelectChange}
              onSelectClick={handleSelectClick}
              onSelectMouseDown={handleSelectMouseDown}
              onInputFocus={handleInputFocus}
              onInputBlur={handleInputBlur}
              onInputKeydown={handleInputKeydown}
              onVersionClick={handleVersionClick}
            />
          ))}
        </div>

        {/* Footer */}
        <div className={style.gridFooter}>
          {footerState.map((tdItem) => (
            <div
              key={tdItem.id}
              className={`${style.selfTd} ${style.gridCell} ${
                tdItem.title.length > 0
                  ? style.selfFooterTitle
                  : style.selfInputReadOnly
              }`}
              style={{
                gridRow: tdItem.rowSpan > 1 ? `span ${tdItem.rowSpan}` : undefined,
                gridColumn: tdItem.colSpan > 1 ? `span ${tdItem.colSpan}` : undefined
              }}
            >
              {tdItem.title.length > 0 ? tdItem.title : tdItem.value}
            </div>
          ))}
        </div>
      </div>
    </div>
  );
}

export default EnterTableListUI;
