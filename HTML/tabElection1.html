<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tab Election Manager æ¼”ç¤º</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            color: #667eea;
            margin-bottom: 10px;
        }
        
        .status-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }
        
        .leader-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }
        
        .leader-yes {
            background: #d4edda;
            color: #155724;
        }
        
        .leader-no {
            background: #f8d7da;
            color: #721c24;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }
        
        button:hover {
            background: #5a6fd8;
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .log-container {
            background: #1a1a1a;
            color: #00ff00;
            border-radius: 8px;
            padding: 15px;
            height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            margin-bottom: 20px;
        }
        
        .log-entry {
            margin-bottom: 5px;
            word-wrap: break-word;
        }
        
        .log-timestamp {
            color: #888;
        }
        
        .info-box {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .info-box h3 {
            margin-top: 0;
            color: #1976d2;
        }
        
        .tabs-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        
        .tab-item {
            background: #e0e0e0;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
        }
        
        .tab-item.leader {
            background: #4caf50;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ† Tab Election Manager</h1>
            <p>å¤šæ ‡ç­¾é¡µé¢†å¯¼è€…é€‰ä¸¾æ¼”ç¤º</p>
        </div>
        
        <div class="info-box">
            <h3>ğŸ“– ä½¿ç”¨è¯´æ˜</h3>
            <p><strong>æ‰“å¼€å¤šä¸ªæ ‡ç­¾é¡µ</strong>æ¥æµ‹è¯•é¢†å¯¼è€…é€‰ä¸¾åŠŸèƒ½ï¼š</p>
            <ul>
                <li>å¤åˆ¶å½“å‰é¡µé¢URLï¼Œåœ¨æ–°æ ‡ç­¾é¡µä¸­æ‰“å¼€</li>
                <li>è§‚å¯Ÿä¸åŒæ ‡ç­¾é¡µä¹‹é—´çš„é¢†å¯¼è€…é€‰ä¸¾è¿‡ç¨‹</li>
                <li>å…³é—­é¢†å¯¼è€…æ ‡ç­¾é¡µï¼Œçœ‹å…¶ä»–æ ‡ç­¾é¡µå¦‚ä½•é‡æ–°é€‰ä¸¾</li>
                <li>ä½¿ç”¨ä¸‹æ–¹æŒ‰é’®æ‰‹åŠ¨è§¦å‘é€‰ä¸¾æˆ–é”€æ¯å®ä¾‹</li>
            </ul>
        </div>
        
        <div class="status-card">
            <h3>ğŸ“Š å½“å‰çŠ¶æ€</h3>
            <div id="status">
                <p>ğŸ“‹ Tab ID: <code id="tabId">-</code></p>
                <p>ğŸ‘‘ æ˜¯å¦ä¸ºé¢†å¯¼è€…: <span id="isLeader">-</span></p>
                <p>ğŸ¯ å½“å‰é¢†å¯¼è€…: <code id="currentLeader">-</code></p>
                <p>ğŸ“± æ´»è·ƒæ ‡ç­¾é¡µæ•°é‡: <span id="activeTabsCount">-</span></p>
                <p>ğŸ”„ å®ä¾‹çŠ¶æ€: <span id="instanceStatus">-</span></p>
            </div>
            <div class="tabs-list" id="tabsList"></div>
        </div>
        
        <div class="controls">
            <button onclick="triggerElection()">ğŸ—³ï¸ æ‰‹åŠ¨è§¦å‘é€‰ä¸¾</button>
            <button onclick="destroyManager()">ğŸ’¥ é”€æ¯å®ä¾‹</button>
            <button onclick="recreateManager()">ğŸ”„ é‡æ–°åˆ›å»ºå®ä¾‹</button>
            <button onclick="clearLogs()">ğŸ§¹ æ¸…ç©ºæ—¥å¿—</button>
        </div>
        
        <div class="log-container" id="logContainer">
            <div class="log-entry">
                <span class="log-timestamp">[å¯åŠ¨]</span> ç³»ç»Ÿåˆå§‹åŒ–ä¸­...
            </div>
        </div>
    </div>

    <script>
        class TabElectionManager {
          constructor(channelName = 'tab-election') {
            this.channelName = channelName;
            this.channel = null;
            this.tabId = this.generateTabId();
            this.isLeader = false;
            this.isDestroyed = false;
            this.callbacks = {
              onLeaderChange: [],
              onTabJoin: [],
              onTabLeave: []
            };
            
            // é€‰ä¸¾ç›¸å…³
            this.electionTimeout = null;
            this.heartbeatInterval = null;
            this.currentLeader = null;
            this.activeTabs = new Map();
            
            // é…ç½®
            this.config = {
              electionTimeout: 3000,
              heartbeatInterval: 1000,
              leaderTimeout: 5000
            };
            
            this.init();
          }
          
          generateTabId() {
            return `tab_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
          }
          
          init() {
            if (this.isDestroyed) return;
            
            try {
              this.channel = new BroadcastChannel(this.channelName);
              this.channel.addEventListener('message', (event) => this.handleMessage(event));
              
              // é¡µé¢å¸è½½æ—¶æ¸…ç†
              window.addEventListener('beforeunload', () => this.destroy());
              window.addEventListener('unload', () => this.destroy());
              
              // å¯åŠ¨é€‰ä¸¾
              this.startElection();
              
            } catch (error) {
              console.error('Failed to initialize TabElectionManager:', error);
            }
          }
          
          // å®‰å…¨çš„å¹¿æ’­æ–¹æ³•
          broadcast(message) {
            if (this.isDestroyed || !this.channel) {
              console.warn('Cannot broadcast: channel is closed or destroyed');
              return false;
            }
            
            try {
              this.channel.postMessage({
                ...message,
                tabId: this.tabId,
                timestamp: Date.now()
              });
              return true;
            } catch (error) {
              console.error('Broadcast failed:', error);
              if (error.name === 'InvalidStateError') {
                this.isDestroyed = true;
              }
              return false;
            }
          }
          
          handleMessage(event) {
            if (this.isDestroyed) return;
            
            const { type, tabId, timestamp } = event.data;
            
            // å¿½ç•¥è‡ªå·±å‘é€çš„æ¶ˆæ¯
            if (tabId === this.tabId) return;
            
            switch (type) {
              case 'election-start':
                this.handleElectionStart(event.data);
                break;
              case 'election-vote':
                this.handleElectionVote(event.data);
                break;
              case 'leader-announcement':
                this.handleLeaderAnnouncement(event.data);
                break;
              case 'heartbeat':
                this.handleHeartbeat(event.data);
                break;
              case 'tab-join':
                this.handleTabJoin(event.data);
                break;
              case 'tab-leave':
                this.handleTabLeave(event.data);
                break;
            }
          }
          
          startElection() {
            if (this.isDestroyed) return;
            
            console.log(`Tab ${this.tabId} starting election`);
            
            // æ¸…é™¤ä¹‹å‰çš„é€‰ä¸¾
            this.clearElectionTimeout();
            
            // å¹¿æ’­é€‰ä¸¾å¼€å§‹
            this.broadcast({
              type: 'election-start'
            });
            
            // å¹¿æ’­è‡ªå·±åŠ å…¥
            this.broadcast({
              type: 'tab-join'
            });
            
            // è®¾ç½®é€‰ä¸¾è¶…æ—¶
            this.electionTimeout = setTimeout(() => {
              this.concludeElection();
            }, this.config.electionTimeout);
          }
          
          handleElectionStart(data) {
            if (this.isDestroyed) return;
            
            // å¦‚æœæ”¶åˆ°å…¶ä»–æ ‡ç­¾é¡µçš„é€‰ä¸¾è¯·æ±‚ï¼Œå‚ä¸æŠ•ç¥¨
            this.broadcast({
              type: 'election-vote',
              vote: this.tabId
            });
          }
          
          handleElectionVote(data) {
            if (this.isDestroyed) return;
            
            const { tabId, vote } = data;
            this.activeTabs.set(tabId, {
              id: tabId,
              vote: vote,
              lastSeen: Date.now()
            });
          }
          
          concludeElection() {
            if (this.isDestroyed) return;
            
            // æ¸…é™¤é€‰ä¸¾è¶…æ—¶
            this.clearElectionTimeout();
            
            // æ·»åŠ è‡ªå·±åˆ°æ´»è·ƒæ ‡ç­¾é¡µåˆ—è¡¨
            this.activeTabs.set(this.tabId, {
              id: this.tabId,
              vote: this.tabId,
              lastSeen: Date.now()
            });
            
            // é€‰æ‹©é¢†å¯¼è€…ï¼ˆé€‰æ‹©æœ€å°çš„ tabIdï¼‰
            const sortedTabs = Array.from(this.activeTabs.values())
              .sort((a, b) => a.id.localeCompare(b.id));
            
            if (sortedTabs.length > 0) {
              const leaderId = sortedTabs[0].id;
              
              if (leaderId === this.tabId) {
                this.becomeLeader();
              } else {
                this.currentLeader = leaderId;
                this.isLeader = false;
              }
            }
          }
          
          becomeLeader() {
            if (this.isDestroyed) return;
            
            console.log(`Tab ${this.tabId} became leader`);
            this.isLeader = true;
            this.currentLeader = this.tabId;
            
            // å¹¿æ’­é¢†å¯¼è€…å£°æ˜
            const announced = this.broadcast({
              type: 'leader-announcement'
            });
            
            if (announced) {
              // å¼€å§‹å¿ƒè·³
              this.startHeartbeat();
              
              // è§¦å‘å›è°ƒ
              this.triggerCallback('onLeaderChange', {
                isLeader: true,
                leaderId: this.tabId
              });
            }
          }
          
          handleLeaderAnnouncement(data) {
            if (this.isDestroyed) return;
            
            const { tabId } = data;
            
            if (this.isLeader && tabId !== this.tabId) {
              // å¦‚æœå½“å‰æ˜¯é¢†å¯¼è€…ä½†æ”¶åˆ°å…¶ä»–é¢†å¯¼è€…å£°æ˜ï¼Œæ¯”è¾ƒ tabId
              if (tabId < this.tabId) {
                this.resignLeadership();
                this.currentLeader = tabId;
              }
            } else {
              this.currentLeader = tabId;
              this.isLeader = false;
              
              this.triggerCallback('onLeaderChange', {
                isLeader: false,
                leaderId: tabId
              });
            }
          }
          
          startHeartbeat() {
            if (this.isDestroyed) return;
            
            this.clearHeartbeat();
            
            this.heartbeatInterval = setInterval(() => {
              if (this.isDestroyed) {
                this.clearHeartbeat();
                return;
              }
              
              if (this.isLeader) {
                const heartbeatSent = this.broadcast({
                  type: 'heartbeat'
                });
                
                // å¦‚æœå¿ƒè·³å‘é€å¤±è´¥ï¼Œå¯èƒ½éœ€è¦é‡æ–°åˆå§‹åŒ–
                if (!heartbeatSent) {
                  this.clearHeartbeat();
                  this.resignLeadership();
                }
              }
            }, this.config.heartbeatInterval);
          }
          
          handleHeartbeat(data) {
            if (this.isDestroyed) return;
            
            const { tabId } = data;
            
            // æ›´æ–°é¢†å¯¼è€…çš„æœ€åå¿ƒè·³æ—¶é—´
            if (tabId === this.currentLeader) {
              this.activeTabs.set(tabId, {
                id: tabId,
                lastSeen: Date.now()
              });
            }
          }
          
          handleTabJoin(data) {
            if (this.isDestroyed) return;
            
            const { tabId } = data;
            this.activeTabs.set(tabId, {
              id: tabId,
              lastSeen: Date.now()
            });
            
            this.triggerCallback('onTabJoin', { tabId });
            
            // å¦‚æœæ˜¯é¢†å¯¼è€…ï¼Œå‘æ–°æ ‡ç­¾é¡µå®£å¸ƒè‡ªå·±çš„åœ°ä½
            if (this.isLeader) {
              setTimeout(() => {
                this.broadcast({
                  type: 'leader-announcement'
                });
              }, 100);
            }
          }
          
          handleTabLeave(data) {
            if (this.isDestroyed) return;
            
            const { tabId } = data;
            this.activeTabs.delete(tabId);
            
            this.triggerCallback('onTabLeave', { tabId });
            
            // å¦‚æœç¦»å¼€çš„æ˜¯é¢†å¯¼è€…ï¼Œå¼€å§‹æ–°çš„é€‰ä¸¾
            if (tabId === this.currentLeader) {
              console.log('Leader left, starting new election');
              this.currentLeader = null;
              this.isLeader = false;
              this.startElection();
            }
          }
          
          resignLeadership() {
            if (this.isLeader) {
              console.log(`Tab ${this.tabId} resigned from leadership`);
              this.isLeader = false;
              this.clearHeartbeat();
              
              this.triggerCallback('onLeaderChange', {
                isLeader: false,
                leaderId: this.currentLeader
              });
            }
          }
          
          clearElectionTimeout() {
            if (this.electionTimeout) {
              clearTimeout(this.electionTimeout);
              this.electionTimeout = null;
            }
          }
          
          clearHeartbeat() {
            if (this.heartbeatInterval) {
              clearInterval(this.heartbeatInterval);
              this.heartbeatInterval = null;
            }
          }
          
          // äº‹ä»¶ç›‘å¬
          on(event, callback) {
            if (this.callbacks[event]) {
              this.callbacks[event].push(callback);
            }
          }
          
          off(event, callback) {
            if (this.callbacks[event]) {
              const index = this.callbacks[event].indexOf(callback);
              if (index > -1) {
                this.callbacks[event].splice(index, 1);
              }
            }
          }
          
          triggerCallback(event, data) {
            if (this.callbacks[event]) {
              this.callbacks[event].forEach(callback => {
                try {
                  callback(data);
                } catch (error) {
                  console.error(`Error in ${event} callback:`, error);
                }
              });
            }
          }
          
          // è·å–çŠ¶æ€
          getStatus() {
            return {
              tabId: this.tabId,
              isLeader: this.isLeader,
              currentLeader: this.currentLeader,
              activeTabs: Array.from(this.activeTabs.keys()),
              isDestroyed: this.isDestroyed
            };
          }
          
          // æ‰‹åŠ¨è§¦å‘é€‰ä¸¾
          triggerElection() {
            if (!this.isDestroyed) {
              this.startElection();
            }
          }
          
          // é”€æ¯å®ä¾‹
          destroy() {
            if (this.isDestroyed) return;
            
            console.log(`Tab ${this.tabId} is being destroyed`);
            this.isDestroyed = true;
            
            // å¹¿æ’­ç¦»å¼€æ¶ˆæ¯
            if (this.channel) {
              try {
                this.channel.postMessage({
                  type: 'tab-leave',
                  tabId: this.tabId,
                  timestamp: Date.now()
                });
              } catch (error) {
                console.warn('Failed to broadcast tab-leave message:', error);
              }
            }
            
            // æ¸…ç†å®šæ—¶å™¨
            this.clearElectionTimeout();
            this.clearHeartbeat();
            
            // å…³é—­å¹¿æ’­é¢‘é“
            if (this.channel) {
              try {
                this.channel.close();
              } catch (error) {
                console.warn('Failed to close broadcast channel:', error);
              }
              this.channel = null;
            }
            
            // é‡ç½®çŠ¶æ€
            this.isLeader = false;
            this.currentLeader = null;
            this.activeTabs.clear();
            this.callbacks = {
              onLeaderChange: [],
              onTabJoin: [],
              onTabLeave: []
            };
          }
        }

        // å…¨å±€å˜é‡
        let tabManager = null;
        
        // æ—¥å¿—å‡½æ•°
        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.innerHTML = `<span class="log-timestamp">[${timestamp}]</span> ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        function updateStatus() {
            if (!tabManager) {
                document.getElementById('tabId').textContent = 'æœªåˆå§‹åŒ–';
                document.getElementById('isLeader').innerHTML = '<span class="leader-badge leader-no">æœªçŸ¥</span>';
                document.getElementById('currentLeader').textContent = 'æ— ';
                document.getElementById('activeTabsCount').textContent = '0';
                document.getElementById('instanceStatus').textContent = 'å·²é”€æ¯';
                document.getElementById('tabsList').innerHTML = '';
                return;
            }
            
            const status = tabManager.getStatus();
            
            document.getElementById('tabId').textContent = status.tabId.substring(0, 20) + '...';
            document.getElementById('isLeader').innerHTML = status.isLeader 
                ? '<span class="leader-badge leader-yes">æ˜¯</span>' 
                : '<span class="leader-badge leader-no">å¦</span>';
            document.getElementById('currentLeader').textContent = status.currentLeader 
                ? status.currentLeader.substring(0, 20) + '...' 
                : 'æ— ';
            document.getElementById('activeTabsCount').textContent = status.activeTabs.length;
            document.getElementById('instanceStatus').textContent = status.isDestroyed ? 'å·²é”€æ¯' : 'è¿è¡Œä¸­';
            
            // æ›´æ–°æ ‡ç­¾é¡µåˆ—è¡¨
            const tabsList = document.getElementById('tabsList');
            tabsList.innerHTML = '';
            
            // æ·»åŠ å½“å‰æ ‡ç­¾é¡µ
            const currentTab = document.createElement('div');
            currentTab.className = `tab-item ${status.isLeader ? 'leader' : ''}`;
            currentTab.textContent = `å½“å‰ (${status.tabId.substring(4, 10)})`;
            tabsList.appendChild(currentTab);
            
            // æ·»åŠ å…¶ä»–æ ‡ç­¾é¡µ
            status.activeTabs.forEach(tabId => {
                if (tabId !== status.tabId) {
                    const tabItem = document.createElement('div');
                    tabItem.className = `tab-item ${tabId === status.currentLeader ? 'leader' : ''}`;
                    tabItem.textContent = tabId.substring(4, 10);
                    tabsList.appendChild(tabItem);
                }
            });
        }
        
        // åˆå§‹åŒ–ç®¡ç†å™¨
        function initManager() {
            if (tabManager) {
                tabManager.destroy();
            }
            
            tabManager = new TabElectionManager('demo-election');
            
            // æ³¨å†Œäº‹ä»¶ç›‘å¬å™¨
            tabManager.on('onLeaderChange', (data) => {
                addLog(`ğŸ† é¢†å¯¼æƒå˜æ›´: ${data.isLeader ? 'æˆä¸ºé¢†å¯¼è€…' : 'å¤±å»é¢†å¯¼æƒ'} (é¢†å¯¼è€…: ${data.leaderId.substring(4, 10)})`);
                updateStatus();
            });
            
            tabManager.on('onTabJoin', (data) => {
                addLog(`ğŸ“± æ ‡ç­¾é¡µåŠ å…¥: ${data.tabId.substring(4, 10)}`);
                updateStatus();
            });
            
            tabManager.on('onTabLeave', (data) => {
                addLog(`ğŸ“± æ ‡ç­¾é¡µç¦»å¼€: ${data.tabId.substring(4, 10)}`);
                updateStatus();
            });
            
            addLog(`ğŸš€ Tab Election Manager å·²åˆå§‹åŒ– (ID: ${tabManager.tabId.substring(4, 10)})`);
            updateStatus();
        }
        
        // æ§åˆ¶å‡½æ•°
        function triggerElection() {
            if (tabManager && !tabManager.isDestroyed) {
                tabManager.triggerElection();
                addLog('ğŸ—³ï¸ æ‰‹åŠ¨è§¦å‘é€‰ä¸¾');
            } else {
                addLog('âŒ æ— æ³•è§¦å‘é€‰ä¸¾: å®ä¾‹æœªåˆå§‹åŒ–æˆ–å·²é”€æ¯');
            }
        }
        
        function destroyManager() {
            if (tabManager) {
                const tabId = tabManager.tabId.substring(4, 10);
                tabManager.destroy();
                addLog(`ğŸ’¥ å®ä¾‹å·²é”€æ¯ (ID: ${tabId})`);
                tabManager = null;
                updateStatus();
            } else {
                addLog('âŒ æ²¡æœ‰å¯é”€æ¯çš„å®ä¾‹');
            }
        }
        
        function recreateManager() {
            addLog('ğŸ”„ é‡æ–°åˆ›å»ºå®ä¾‹...');
            initManager();
        }
        
        function clearLogs() {
            document.getElementById('logContainer').innerHTML = '';
            addLog('ğŸ§¹ æ—¥å¿—å·²æ¸…ç©º');
        }
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            addLog('ğŸ“„ é¡µé¢åŠ è½½å®Œæˆ');
            initManager();
            
            // å®šæœŸæ›´æ–°çŠ¶æ€æ˜¾ç¤º
            setInterval(updateStatus, 1000);
        });
        
        // é¡µé¢å¸è½½æ—¶æ¸…ç†
        window.addEventListener('beforeunload', () => {
            if (tabManager) {
                tabManager.destroy();
            }
        });
    </script>
</body>
</html>