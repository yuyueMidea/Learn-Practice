<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŠ¨æ€è¡¨å•ç”Ÿæˆå™¨ Pro</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            height: 100vh;
            overflow: hidden;
        }

        /* é¡¶éƒ¨å·¥å…·æ  */
        .toolbar {
            background: white;
            border-bottom: 1px solid #e0e0e0;
            padding: 12px 16px;
            display: flex;
            gap: 12px;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .toolbar-title {
            font-size: 18px;
            font-weight: 600;
            margin-right: auto;
            color: #24292f;
        }

        .btn {
            padding: 8px 16px;
            border: 1px solid #d0d7de;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .btn:hover {
            background: #f6f8fa;
        }

        .btn.primary {
            background: #0969da;
            color: white;
            border-color: #0969da;
        }

        .btn.primary:hover {
            background: #0550ae;
        }

        .btn.success {
            background: #1f883d;
            color: white;
            border-color: #1f883d;
        }

        .btn.success:hover {
            background: #1a7f37;
        }

        .btn.danger {
            background: #da3633;
            color: white;
            border-color: #da3633;
        }

        .btn.danger:hover {
            background: #b52a2a;
        }

        /* ä¸»å®¹å™¨ */
        .container {
            display: flex;
            height: calc(100vh - 60px);
        }

        /* å·¦ä¾§ç»„ä»¶é¢æ¿ */
        .left-panel {
            width: 280px;
            background: white;
            border-right: 1px solid #e0e0e0;
            overflow-y: auto;
        }

        .panel-section {
            border-bottom: 1px solid #e0e0e0;
        }

        .section-title {
            padding: 12px 16px;
            font-weight: 600;
            background: #f8f9fa;
            color: #24292f;
            cursor: pointer;
            user-select: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-title:hover {
            background: #f0f1f2;
        }

        .section-toggle {
            font-size: 12px;
            transition: transform 0.2s;
        }

        .section-toggle.collapsed {
            transform: rotate(-90deg);
        }

        .component-list {
            padding: 12px;
            display: none;
        }

        .component-list.expanded {
            display: block;
        }

        .component-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            margin-bottom: 8px;
            cursor: grab;
            transition: all 0.2s;
            background: white;
        }

        .component-item:hover {
            border-color: #0969da;
            background: #f6f8fa;
            transform: translateX(2px);
        }

        .component-item:active {
            cursor: grabbing;
        }

        .component-icon {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: white;
        }

        .component-icon.layout {
            background: #8250df;
        }

        .component-icon.form {
            background: #0969da;
        }

        .component-desc {
            font-size: 11px;
            color: #666;
        }

        /* ä¸­é—´ç”»å¸ƒåŒºåŸŸ */
        .canvas-area {
            flex: 1;
            background: #f8f9fa;
            position: relative;
            overflow: auto;
        }

        .canvas {
            min-height: 100%;
            padding: 20px;
        }

        .drop-zone {
            min-height: calc(100vh - 140px);
            border: 2px dashed #d0d7de;
            border-radius: 8px;
            background: white;
            position: relative;
            padding: 20px;
        }

        .drop-zone.drag-over {
            border-color: #0969da;
            background: #f0f6ff;
        }

        .drop-placeholder {
            text-align: center;
            color: #656d76;
            font-size: 16px;
            padding: 60px 20px;
        }

        /* è¡Œå®¹å™¨æ ·å¼ - æ”¯æŒè‡ªåŠ¨æ¢è¡Œ */
        .container-element.row {
            border: 2px solid #8250df;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            background: #fafbfc;
            position: relative;
            min-height: 120px;
        }

        .container-element.row .container-content {
            display: flex;
            gap: 12px;
            flex-wrap: wrap; /* å…³é”®ï¼šæ”¯æŒè‡ªåŠ¨æ¢è¡Œ */
            min-height: 80px;
        }

        /* åˆ—å®¹å™¨æ ·å¼ - å‚ç›´å¸ƒå±€ */
        .container-element.column {
            border: 2px solid #1f883d;
            border-radius: 6px;
            padding: 12px;
            background: #f6f8fa;
            position: relative;
            min-height: 100px;
            flex-shrink: 0;
        }

        /* Columnå†…éƒ¨å‚ç›´æ’åˆ— */
        .container-element.column .container-content {
            display: flex;
            flex-direction: column; /* å…³é”®ï¼šå‚ç›´æ’åˆ— */
            gap: 12px;
        }

        /* æ …æ ¼å®½åº¦ */
        .col-span-1 { flex: 0 0 calc(8.333% - 10px); }
        .col-span-2 { flex: 0 0 calc(16.666% - 10px); }
        .col-span-3 { flex: 0 0 calc(25% - 10px); }
        .col-span-4 { flex: 0 0 calc(33.333% - 10px); }
        .col-span-5 { flex: 0 0 calc(41.666% - 10px); }
        .col-span-6 { flex: 0 0 calc(50% - 10px); }
        .col-span-7 { flex: 0 0 calc(58.333% - 10px); }
        .col-span-8 { flex: 0 0 calc(66.666% - 10px); }
        .col-span-9 { flex: 0 0 calc(75% - 10px); }
        .col-span-10 { flex: 0 0 calc(83.333% - 10px); }
        .col-span-11 { flex: 0 0 calc(91.666% - 10px); }
        .col-span-12 { flex: 0 0 calc(100% - 10px); }

        /* åˆ†ç»„å®¹å™¨æ ·å¼ */
        .container-element.group {
            border: 2px solid #bf3989;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            background: #fafbfc;
            position: relative;
            min-height: 100px;
        }

        .container-label {
            position: absolute;
            top: -10px;
            left: 12px;
            background: white;
            padding: 2px 8px;
            font-size: 12px;
            font-weight: 600;
            border-radius: 3px;
            z-index: 5;
        }

        .container-element.row .container-label {
            color: #8250df;
            border: 1px solid #8250df;
        }

        .container-element.column .container-label {
            color: #1f883d;
            border: 1px solid #1f883d;
        }

        .container-element.group .container-label {
            color: #bf3989;
            border: 1px solid #bf3989;
        }

        .container-content {
            min-height: 50px;
            position: relative;
        }

        .container-content.can-drop {
            outline: 2px dashed #0969da;
            outline-offset: 4px;
            background: rgba(9, 105, 218, 0.05);
        }

        .container-placeholder {
            text-align: center;
            color: #999;
            font-size: 13px;
            padding: 20px;
            border: 1px dashed #ddd;
            border-radius: 4px;
            pointer-events: none;
        }

        /* è¡¨å•å­—æ®µæ ·å¼ */
        .form-field {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 16px;
            margin-bottom: 0; /* Columnå†…éƒ¨é€šè¿‡gapæ§åˆ¶é—´è· */
            position: relative;
            cursor: pointer;
            transition: all 0.2s;
        }

        .form-field:hover {
            border-color: #0969da;
            box-shadow: 0 2px 8px rgba(9, 105, 218, 0.1);
        }

        .form-field.selected,
        .container-element.selected {
            border-color: #0969da;
            box-shadow: 0 0 0 3px rgba(9, 105, 218, 0.2);
        }

        .field-controls {
            position: absolute;
            top: -12px;
            right: 8px;
            display: none;
            gap: 4px;
            z-index: 10;
        }

        .form-field:hover .field-controls,
        .form-field.selected .field-controls,
        .container-element:hover .field-controls,
        .container-element.selected .field-controls {
            display: flex;
        }

        .control-btn {
            width: 26px;
            height: 26px;
            border: 1px solid #e0e0e0;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .control-btn:hover {
            background: #f6f8fa;
            border-color: #0969da;
            transform: scale(1.1);
        }

        .field-label {
            font-weight: 500;
            margin-bottom: 8px;
            color: #24292f;
        }

        .field-input, .field-select, .field-textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d0d7de;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
        }

        .field-textarea {
            resize: vertical;
            min-height: 80px;
        }

        .field-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* å³ä¾§å±æ€§é¢æ¿ */
        .right-panel {
            width: 320px;
            background: white;
            border-left: 1px solid #e0e0e0;
            overflow-y: auto;
        }

        .config-section {
            padding: 16px;
            border-bottom: 1px solid #e0e0e0;
        }

        .config-title {
            font-weight: 600;
            margin-bottom: 16px;
            color: #24292f;
        }

        .config-item {
            margin-bottom: 16px;
        }

        .config-label {
            display: block;
            font-weight: 500;
            margin-bottom: 6px;
            color: #24292f;
            font-size: 13px;
        }

        .config-input, .config-select, .config-textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d0d7de;
            border-radius: 6px;
            font-size: 14px;
        }

        .config-textarea {
            resize: vertical;
            min-height: 60px;
        }

        .config-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }

        /* é€‰é¡¹é…ç½® */
        .options-config {
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 12px;
            background: #fafbfc;
        }

        .option-item {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
            align-items: center;
        }

        .option-input {
            flex: 1;
            padding: 6px 8px;
            border: 1px solid #d0d7de;
            border-radius: 4px;
            font-size: 13px;
        }

        .remove-option {
            background: #da3633;
            color: white;
            border: none;
            border-radius: 3px;
            width: 26px;
            height: 26px;
            cursor: pointer;
            font-size: 14px;
        }

        .add-option {
            background: #0969da;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 12px;
            cursor: pointer;
            font-size: 13px;
            width: 100%;
            margin-top: 4px;
        }

        /* é¢„è§ˆæ¨¡å¼ */
        .preview-mode .form-field,
        .preview-mode .container-element {
            cursor: default;
        }

        .preview-mode .field-controls {
            display: none !important;
        }

        .preview-mode .container-label {
            display: none !important;
        }

        .preview-mode .container-element {
            border-color: transparent;
        }

        .preview-mode .container-element.row,
        .preview-mode .container-element.group {
            background: transparent;
            border: none;
            padding: 0;
            margin-bottom: 20px;
        }

        .preview-mode .container-element.column {
            background: transparent;
            border: none;
            padding: 8px;
        }

        .preview-mode .form-field {
            pointer-events: auto;
        }

        /* é¢„è§ˆè¡¨å•æäº¤æŒ‰é’® */
        .preview-submit-bar {
            margin-top: 24px;
            padding: 16px;
            background: #f6f8fa;
            border-radius: 6px;
            display: flex;
            gap: 12px;
        }

        .submit-btn {
            padding: 10px 24px;
            border: none;
            border-radius: 6px;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .submit-btn.primary {
            background: #0969da;
            color: white;
        }

        .submit-btn.primary:hover {
            background: #0550ae;
        }

        .submit-btn.secondary {
            background: white;
            color: #24292f;
            border: 1px solid #d0d7de;
        }

        .submit-btn.secondary:hover {
            background: #f6f8fa;
        }

        /* è¡¨å•æ•°æ®æ˜¾ç¤º */
        .form-data-display {
            margin-top: 20px;
            padding: 16px;
            background: #f6f8fa;
            border: 1px solid #d0d7de;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 400px;
            overflow-y: auto;
        }

        .form-data-display pre {
            margin: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        /* éšè—æ–‡ä»¶è¾“å…¥ */
        .hidden-file-input {
            display: none;
        }

        /* ç©ºçŠ¶æ€ */
        .empty-state {
            text-align: center;
            color: #656d76;
            padding: 40px 20px;
        }

        /* æ‹–æ‹½å±‚çº§æç¤º */
        .drag-hint {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            pointer-events: none;
            z-index: 10000;
            display: none;
        }

        .drag-hint.show {
            display: block;
        }

        /* å“åº”å¼ */
        @media (max-width: 1200px) {
            .left-panel {
                width: 240px;
            }
            .right-panel {
                width: 280px;
            }
        }
    </style>
</head>
<body>
    <!-- æ‹–æ‹½æç¤º -->
    <div class="drag-hint" id="dragHint"></div>

    <!-- é¡¶éƒ¨å·¥å…·æ  -->
    <div class="toolbar">
        <div class="toolbar-title">ğŸ¨ åŠ¨æ€è¡¨å•ç”Ÿæˆå™¨ Pro</div>
        <button class="btn" id="importBtn">ğŸ“ å¯¼å…¥</button>
        <button class="btn" id="exportBtn">ğŸ’¾ å¯¼å‡º</button>
        <button class="btn danger" id="clearBtn">ğŸ—‘ï¸ æ¸…ç©º</button>
        <button class="btn primary" id="previewBtn">ğŸ‘€ é¢„è§ˆ</button>
        <button class="btn success" id="previewFormBtn" style="display:none;">ğŸ“‹ é¢„è§ˆè¡¨å•</button>
        <input type="file" class="hidden-file-input" id="fileInput" accept=".json">
    </div>

    <!-- ä¸»å®¹å™¨ -->
    <div class="container">
        <!-- å·¦ä¾§ç»„ä»¶é¢æ¿ -->
        <div class="left-panel" id="leftPanel">
            <!-- å¸ƒå±€ç»„ä»¶ -->
            <div class="panel-section">
                <div class="section-title" onclick="toggleSection(this)">
                    <span>ğŸ“ å¸ƒå±€ç»„ä»¶</span>
                    <span class="section-toggle">â–¼</span>
                </div>
                <div class="component-list expanded">
                    <div class="component-item" draggable="true" data-type="row" data-level="1">
                        <div class="component-icon layout">â¬Œ</div>
                        <div>
                            <div>è¡Œå®¹å™¨ (Row)</div>
                            <div class="component-desc">è‡ªåŠ¨æ¢è¡Œ</div>
                        </div>
                    </div>
                    <div class="component-item" draggable="true" data-type="column" data-level="2">
                        <div class="component-icon layout">â¬</div>
                        <div>
                            <div>åˆ—å®¹å™¨ (Column)</div>
                            <div class="component-desc">æ”¾å…¥Rowä¸­</div>
                        </div>
                    </div>
                    <div class="component-item" draggable="true" data-type="group" data-level="1">
                        <div class="component-icon layout">â–¦</div>
                        <div>
                            <div>åˆ†ç»„ (Group)</div>
                            <div class="component-desc">é€»è¾‘åˆ†ç»„</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- è¡¨å•ç»„ä»¶ -->
            <div class="panel-section">
                <div class="section-title" onclick="toggleSection(this)">
                    <span>ğŸ“ è¡¨å•ç»„ä»¶</span>
                    <span class="section-toggle">â–¼</span>
                </div>
                <div class="component-list expanded">
                    <div class="component-item" draggable="true" data-type="input" data-level="3">
                        <div class="component-icon form">T</div>
                        <div>æ–‡æœ¬è¾“å…¥æ¡†</div>
                    </div>
                    <div class="component-item" draggable="true" data-type="textarea" data-level="3">
                        <div class="component-icon form">â‰¡</div>
                        <div>å¤šè¡Œæ–‡æœ¬æ¡†</div>
                    </div>
                    <div class="component-item" draggable="true" data-type="select" data-level="3">
                        <div class="component-icon form">â–¼</div>
                        <div>ä¸‹æ‹‰é€‰æ‹©å™¨</div>
                    </div>
                    <div class="component-item" draggable="true" data-type="radio" data-level="3">
                        <div class="component-icon form">â—‰</div>
                        <div>å•é€‰æŒ‰é’®ç»„</div>
                    </div>
                    <div class="component-item" draggable="true" data-type="checkbox" data-level="3">
                        <div class="component-icon form">â˜‘</div>
                        <div>å¤é€‰æ¡†</div>
                    </div>
                    <div class="component-item" draggable="true" data-type="number" data-level="3">
                        <div class="component-icon form">#</div>
                        <div>æ•°å­—è¾“å…¥æ¡†</div>
                    </div>
                    <div class="component-item" draggable="true" data-type="date" data-level="3">
                        <div class="component-icon form">ğŸ“…</div>
                        <div>æ—¥æœŸé€‰æ‹©å™¨</div>
                    </div>
                    <div class="component-item" draggable="true" data-type="email" data-level="3">
                        <div class="component-icon form">@</div>
                        <div>é‚®ç®±è¾“å…¥æ¡†</div>
                    </div>
                    <div class="component-item" draggable="true" data-type="tel" data-level="3">
                        <div class="component-icon form">ğŸ“</div>
                        <div>ç”µè¯è¾“å…¥æ¡†</div>
                    </div>
                    <div class="component-item" draggable="true" data-type="url" data-level="3">
                        <div class="component-icon form">ğŸ”—</div>
                        <div>URLè¾“å…¥æ¡†</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ä¸­é—´ç”»å¸ƒåŒºåŸŸ -->
        <div class="canvas-area">
            <div class="canvas">
                <div class="drop-zone" id="dropZone">
                    <div class="drop-placeholder" id="dropPlaceholder">
                        æ‹–æ‹½å·¦ä¾§ç»„ä»¶åˆ°è¿™é‡Œå¼€å§‹åˆ›å»ºè¡¨å•
                    </div>
                </div>
            </div>
        </div>

        <!-- å³ä¾§å±æ€§é¢æ¿ -->
        <div class="right-panel" id="rightPanel">
            <div class="config-section">
                <div class="config-title">å±æ€§é…ç½®</div>
                <div id="fieldConfig">
                    <div class="empty-state">
                        é€‰æ‹©ä¸€ä¸ªå­—æ®µæˆ–å®¹å™¨æ¥é…ç½®å±æ€§
                    </div>
                </div>
            </div>
            
            <div class="config-section">
                <div class="config-title">å®æ—¶é¢„è§ˆ</div>
                <div id="livePreview">
                    <div class="empty-state">
                        é¢„è§ˆåŒºåŸŸ
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // åˆ‡æ¢é¢æ¿æŠ˜å 
        function toggleSection(element) {
            const toggle = element.querySelector('.section-toggle');
            const list = element.nextElementSibling;
            
            list.classList.toggle('expanded');
            toggle.classList.toggle('collapsed');
        }

        // æ‹–æ‹½å±‚çº§è§„åˆ™
        const DRAG_RULES = {
            row: { canDropIn: ['dropZone', 'group'], canContain: ['column'] },
            column: { canDropIn: ['row'], canContain: ['input', 'textarea', 'select', 'radio', 'checkbox', 'number', 'date', 'email', 'tel', 'url'] },
            group: { canDropIn: ['dropZone'], canContain: ['row', 'column', 'input', 'textarea', 'select', 'radio', 'checkbox', 'number', 'date', 'email', 'tel', 'url'] },
            // è¡¨å•ç»„ä»¶
            input: { canDropIn: ['column', 'group', 'dropZone'], canContain: [] },
            textarea: { canDropIn: ['column', 'group', 'dropZone'], canContain: [] },
            select: { canDropIn: ['column', 'group', 'dropZone'], canContain: [] },
            radio: { canDropIn: ['column', 'group', 'dropZone'], canContain: [] },
            checkbox: { canDropIn: ['column', 'group', 'dropZone'], canContain: [] },
            number: { canDropIn: ['column', 'group', 'dropZone'], canContain: [] },
            date: { canDropIn: ['column', 'group', 'dropZone'], canContain: [] },
            email: { canDropIn: ['column', 'group', 'dropZone'], canContain: [] },
            tel: { canDropIn: ['column', 'group', 'dropZone'], canContain: [] },
            url: { canDropIn: ['column', 'group', 'dropZone'], canContain: [] }
        };

        class FormBuilder {
            constructor() {
                this.elements = [];
                this.selectedElement = null;
                this.isPreviewMode = false;
                this.elementIdCounter = 1;
                this.currentDragType = null;
                
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.setupDragAndDrop();
                this.render();
            }

            setupEventListeners() {
                document.getElementById('importBtn').addEventListener('click', () => this.importSchema());
                document.getElementById('exportBtn').addEventListener('click', () => this.exportSchema());
                document.getElementById('clearBtn').addEventListener('click', () => this.clearCanvas());
                document.getElementById('previewBtn').addEventListener('click', () => this.togglePreview());
                document.getElementById('previewFormBtn').addEventListener('click', () => this.showPreviewForm());
                document.getElementById('fileInput').addEventListener('change', (e) => this.handleFileImport(e));

                // ç‚¹å‡»ç©ºç™½åŒºåŸŸå–æ¶ˆé€‰æ‹©ï¼ˆä»…ç¼–è¾‘æ¨¡å¼ï¼‰
                document.addEventListener('click', (e) => {
                    if (this.isPreviewMode) return; // é¢„è§ˆæ¨¡å¼ä¸å–æ¶ˆé€‰æ‹©
                    
                    if (!e.target.closest('.form-field') && 
                        !e.target.closest('.container-element') && 
                        !e.target.closest('.right-panel') &&
                        !e.target.closest('.control-btn')) {
                        this.selectElement(null);
                    }
                });

                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Delete' && this.selectedElement && !e.target.closest('.config-input, .option-input')) {
                        e.preventDefault();
                        this.removeElement(this.selectedElement.id);
                    }
                });
            }

            setupDragAndDrop() {
                const componentItems = document.querySelectorAll('.component-item');
                
                componentItems.forEach(item => {
                    item.addEventListener('dragstart', (e) => {
                        const type = item.dataset.type;
                        this.currentDragType = type;
                        e.dataTransfer.setData('text/plain', type);
                        e.dataTransfer.effectAllowed = 'copy';
                    });

                    item.addEventListener('dragend', () => {
                        this.currentDragType = null;
                        this.hideAllDropHints();
                    });
                });

                this.setupMainDropZone();
            }

            setupMainDropZone() {
                const zone = document.getElementById('dropZone');

                zone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    if (this.canDropInZone('dropZone', this.currentDragType)) {
                        e.dataTransfer.dropEffect = 'copy';
                        zone.classList.add('drag-over');
                    } else {
                        e.dataTransfer.dropEffect = 'none';
                        this.showDragHint('è¯¥ç»„ä»¶ä¸èƒ½ç›´æ¥æ”¾åœ¨ç”»å¸ƒä¸Š');
                    }
                });

                zone.addEventListener('dragleave', (e) => {
                    if (!zone.contains(e.relatedTarget)) {
                        zone.classList.remove('drag-over');
                        this.hideDragHint();
                    }
                });

                zone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    zone.classList.remove('drag-over');
                    this.hideDragHint();
                    
                    const componentType = e.dataTransfer.getData('text/plain');
                    if (componentType && this.canDropInZone('dropZone', componentType)) {
                        this.addElement(componentType, null);
                    }
                });
            }

            canDropInZone(zoneType, dragType) {
                if (!dragType || !DRAG_RULES[dragType]) return false;
                return DRAG_RULES[dragType].canDropIn.includes(zoneType);
            }

            canContainType(containerType, childType) {
                if (!containerType || !childType) return false;
                if (!DRAG_RULES[containerType]) return false;
                return DRAG_RULES[containerType].canContain.includes(childType);
            }

            showDragHint(message) {
                const hint = document.getElementById('dragHint');
                hint.textContent = message;
                hint.classList.add('show');
            }

            hideDragHint() {
                const hint = document.getElementById('dragHint');
                hint.classList.remove('show');
            }

            hideAllDropHints() {
                document.querySelectorAll('.container-content').forEach(el => {
                    el.classList.remove('can-drop');
                });
            }

            addElement(type, parentId = null) {
                const element = this.createElement(type);
                
                if (parentId) {
                    const parent = this.findElementById(parentId, this.elements);
                    if (parent && parent.children) {
                        parent.children.push(element);
                    }
                } else {
                    this.elements.push(element);
                }
                
                this.render();
                this.selectElement(element);
            }

            createElement(type) {
                const isLayout = ['row', 'column', 'group'].includes(type);
                
                const element = {
                    id: `element_${this.elementIdCounter++}`,
                    type: type,
                    label: this.getDefaultLabel(type),
                    children: isLayout ? [] : null
                };

                // Column ç‰¹æœ‰å±æ€§
                if (type === 'column') {
                    element.span = 6; // é»˜è®¤å 6åˆ—ï¼ˆåŠå®½ï¼‰
                }

                if (!isLayout) {
                    element.placeholder = '';
                    element.required = false;
                    
                    if (type === 'select' || type === 'radio') {
                        element.options = [
                            { label: 'é€‰é¡¹1', value: 'option1' },
                            { label: 'é€‰é¡¹2', value: 'option2' }
                        ];
                    }

                    switch (type) {
                        case 'number':
                            element.min = '';
                            element.max = '';
                            element.step = '1';
                            break;
                        case 'textarea':
                            element.rows = 4;
                            break;
                        case 'email':
                            element.placeholder = 'è¯·è¾“å…¥é‚®ç®±åœ°å€';
                            break;
                        case 'tel':
                            element.placeholder = 'è¯·è¾“å…¥ç”µè¯å·ç ';
                            break;
                        case 'url':
                            element.placeholder = 'è¯·è¾“å…¥ç½‘å€';
                            break;
                    }
                }

                return element;
            }

            getDefaultLabel(type) {
                const labels = {
                    row: 'è¡Œå®¹å™¨',
                    column: 'åˆ—å®¹å™¨',
                    group: 'åˆ†ç»„',
                    input: 'æ–‡æœ¬è¾“å…¥',
                    textarea: 'å¤šè¡Œæ–‡æœ¬',
                    select: 'ä¸‹æ‹‰é€‰æ‹©',
                    radio: 'å•é€‰é€‰æ‹©',
                    checkbox: 'å‹¾é€‰é¡¹',
                    number: 'æ•°å­—è¾“å…¥',
                    date: 'æ—¥æœŸé€‰æ‹©',
                    email: 'é‚®ç®±è¾“å…¥',
                    tel: 'ç”µè¯è¾“å…¥',
                    url: 'ç½‘å€è¾“å…¥'
                };
                return labels[type] || 'å­—æ®µ';
            }

            findElementById(id, elements) {
                for (const element of elements) {
                    if (element.id === id) return element;
                    if (element.children) {
                        const found = this.findElementById(id, element.children);
                        if (found) return found;
                    }
                }
                return null;
            }

            render() {
                const dropZone = document.getElementById('dropZone');
                
                if (this.elements.length === 0) {
                    dropZone.innerHTML = '<div class="drop-placeholder" id="dropPlaceholder">æ‹–æ‹½å·¦ä¾§ç»„ä»¶åˆ°è¿™é‡Œå¼€å§‹åˆ›å»ºè¡¨å•</div>';
                } else {
                    dropZone.innerHTML = this.renderElements(this.elements);
                    
                    if (!this.isPreviewMode) {
                        this.bindElementEvents();
                        this.setupNestedDropZones();
                    }
                }
                
                dropZone.classList.toggle('preview-mode', this.isPreviewMode);
            }

            renderElements(elements) {
                return elements.map(element => this.renderElement(element)).join('');
            }

            renderElement(element) {
                const isLayout = ['row', 'column', 'group'].includes(element.type);
                const selectedClass = this.selectedElement && this.selectedElement.id === element.id ? 'selected' : '';
                
                if (isLayout) {
                    return this.renderContainer(element, selectedClass);
                } else {
                    return this.renderField(element, selectedClass);
                }
            }

            renderContainer(element, selectedClass) {
                const children = element.children || [];
                const childrenHtml = children.length > 0 
                    ? this.renderElements(children)
                    : `<div class="container-placeholder">æ‹–æ‹½${element.type === 'row' ? 'Columnå®¹å™¨' : 'ç»„ä»¶'}åˆ°è¿™é‡Œ</div>`;

                // Columnå®¹å™¨æ·»åŠ æ …æ ¼ç±»
                const spanClass = element.type === 'column' ? `col-span-${element.span || 6}` : '';

                return `
                    <div class="container-element ${element.type} ${spanClass} ${selectedClass}" data-element-id="${element.id}">
                        <div class="container-label">${element.label}${element.type === 'column' ? ` (${element.span}/12)` : ''}</div>
                        <div class="field-controls">
                            <button class="control-btn" onclick="formBuilder.moveElementUp('${element.id}')" title="ä¸Šç§»">â†‘</button>
                            <button class="control-btn" onclick="formBuilder.moveElementDown('${element.id}')" title="ä¸‹ç§»">â†“</button>
                            <button class="control-btn" onclick="formBuilder.duplicateElement('${element.id}')" title="å¤åˆ¶">ğŸ“‹</button>
                            <button class="control-btn" onclick="formBuilder.removeElement('${element.id}')" title="åˆ é™¤">Ã—</button>
                        </div>
                        <div class="container-content" data-container-id="${element.id}" data-container-type="${element.type}">
                            ${childrenHtml}
                        </div>
                    </div>
                `;
            }

            renderField(element, selectedClass) {
                const fieldId = this.isPreviewMode ? element.id : `preview_${element.id}`;
                let fieldHtml = '';
                
                switch (element.type) {
                    case 'input':
                        fieldHtml = `<input type="text" class="field-input" id="${fieldId}" name="${element.id}" placeholder="${element.placeholder}" ${element.required ? 'required' : ''}>`;
                        break;
                    case 'textarea':
                        fieldHtml = `<textarea class="field-textarea" id="${fieldId}" name="${element.id}" placeholder="${element.placeholder}" rows="${element.rows || 4}" ${element.required ? 'required' : ''}></textarea>`;
                        break;
                    case 'select':
                        const options = element.options || [];
                        fieldHtml = `<select class="field-select" id="${fieldId}" name="${element.id}" ${element.required ? 'required' : ''}>
                            <option value="">è¯·é€‰æ‹©...</option>
                            ${options.map(opt => `<option value="${opt.value}">${opt.label}</option>`).join('')}
                        </select>`;
                        break;
                    case 'radio':
                        const radioOptions = element.options || [];
                        fieldHtml = radioOptions.map((opt, idx) => 
                            `<div class="field-checkbox">
                                <input type="radio" name="${element.id}" value="${opt.value}" id="${fieldId}_${idx}" ${element.required && idx === 0 ? 'required' : ''}>
                                <label for="${fieldId}_${idx}">${opt.label}</label>
                            </div>`
                        ).join('');
                        break;
                    case 'checkbox':
                        fieldHtml = `<div class="field-checkbox">
                            <input type="checkbox" id="${fieldId}" name="${element.id}" ${element.required ? 'required' : ''}>
                            <label for="${fieldId}">${element.placeholder || 'åŒæ„æ­¤é¡¹'}</label>
                        </div>`;
                        break;
                    case 'number':
                        fieldHtml = `<input type="number" class="field-input" id="${fieldId}" name="${element.id}" placeholder="${element.placeholder}" 
                            ${element.min ? `min="${element.min}"` : ''} 
                            ${element.max ? `max="${element.max}"` : ''} 
                            ${element.step ? `step="${element.step}"` : ''} 
                            ${element.required ? 'required' : ''}>`;
                        break;
                    case 'date':
                        fieldHtml = `<input type="date" class="field-input" id="${fieldId}" name="${element.id}" ${element.required ? 'required' : ''}>`;
                        break;
                    case 'email':
                        fieldHtml = `<input type="email" class="field-input" id="${fieldId}" name="${element.id}" placeholder="${element.placeholder}" ${element.required ? 'required' : ''}>`;
                        break;
                    case 'tel':
                        fieldHtml = `<input type="tel" class="field-input" id="${fieldId}" name="${element.id}" placeholder="${element.placeholder}" ${element.required ? 'required' : ''}>`;
                        break;
                    case 'url':
                        fieldHtml = `<input type="url" class="field-input" id="${fieldId}" name="${element.id}" placeholder="${element.placeholder}" ${element.required ? 'required' : ''}>`;
                        break;
                }

                return `
                    <div class="form-field ${selectedClass}" data-element-id="${element.id}">
                        <div class="field-controls">
                            <button class="control-btn" onclick="formBuilder.moveElementUp('${element.id}')" title="ä¸Šç§»">â†‘</button>
                            <button class="control-btn" onclick="formBuilder.moveElementDown('${element.id}')" title="ä¸‹ç§»">â†“</button>
                            <button class="control-btn" onclick="formBuilder.duplicateElement('${element.id}')" title="å¤åˆ¶">ğŸ“‹</button>
                            <button class="control-btn" onclick="formBuilder.removeElement('${element.id}')" title="åˆ é™¤">Ã—</button>
                        </div>
                        <div class="field-label">${element.label}${element.required ? ' *' : ''}</div>
                        ${fieldHtml}
                    </div>
                `;
            }

            setupNestedDropZones() {
                const containers = document.querySelectorAll('.container-content');
                containers.forEach(container => {
                    const containerId = container.dataset.containerId;
                    const containerType = container.dataset.containerType;
                    
                    container.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        if (this.canContainType(containerType, this.currentDragType)) {
                            e.dataTransfer.dropEffect = 'copy';
                            container.classList.add('can-drop');
                            this.hideDragHint();
                        } else {
                            e.dataTransfer.dropEffect = 'none';
                            const hints = {
                                row: 'è¡Œå®¹å™¨åªèƒ½æ”¾Columnå®¹å™¨',
                                column: 'Columnå®¹å™¨åªèƒ½æ”¾è¡¨å•ç»„ä»¶',
                                group: 'åˆ†ç»„å¯ä»¥æ”¾ä»»æ„ç»„ä»¶'
                            };
                            this.showDragHint(hints[containerType] || 'ä¸èƒ½æ”¾åœ¨è¿™é‡Œ');
                        }
                    });

                    container.addEventListener('dragleave', (e) => {
                        e.stopPropagation();
                        if (!container.contains(e.relatedTarget)) {
                            container.classList.remove('can-drop');
                        }
                    });

                    container.addEventListener('drop', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        container.classList.remove('can-drop');
                        this.hideDragHint();
                        
                        const componentType = e.dataTransfer.getData('text/plain');
                        if (componentType && this.canContainType(containerType, componentType)) {
                            this.addElement(componentType, containerId);
                        }
                    });
                });
            }

            bindElementEvents() {
                if (this.isPreviewMode) return;
                
                const elements = document.querySelectorAll('.form-field, .container-element');
                elements.forEach(element => {
                    element.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const elementId = element.dataset.elementId;
                        const foundElement = this.findElementById(elementId, this.elements);
                        if (foundElement) {
                            this.selectElement(foundElement);
                        }
                    });
                });
            }

            selectElement(element) {
                this.selectedElement = element;
                this.render();
                this.renderElementConfig();
                this.renderLivePreview();
            }

            renderElementConfig() {
                const configDiv = document.getElementById('fieldConfig');
                
                if (!this.selectedElement) {
                    configDiv.innerHTML = '<div class="empty-state">é€‰æ‹©ä¸€ä¸ªå­—æ®µæˆ–å®¹å™¨æ¥é…ç½®å±æ€§</div>';
                    return;
                }

                const element = this.selectedElement;
                const isLayout = ['row', 'column', 'group'].includes(element.type);

                let configHtml = `
                    <div class="config-item">
                        <label class="config-label">æ ‡ç­¾/æ ‡é¢˜</label>
                        <input type="text" class="config-input" value="${element.label}" 
                               onchange="formBuilder.updateElement('label', this.value)">
                    </div>
                `;

                // Column ç‰¹æœ‰é…ç½®
                if (element.type === 'column') {
                    configHtml += `
                        <div class="config-item">
                            <label class="config-label">åˆ—å®½ (Span) - 12æ …æ ¼ç³»ç»Ÿ</label>
                            <select class="config-select" onchange="formBuilder.updateElement('span', parseInt(this.value))">
                                <option value="1" ${element.span === 1 ? 'selected' : ''}>1/12 (8.3%)</option>
                                <option value="2" ${element.span === 2 ? 'selected' : ''}>2/12 (16.7%)</option>
                                <option value="3" ${element.span === 3 ? 'selected' : ''}>3/12 (25%)</option>
                                <option value="4" ${element.span === 4 ? 'selected' : ''}>4/12 (33.3%)</option>
                                <option value="5" ${element.span === 5 ? 'selected' : ''}>5/12 (41.7%)</option>
                                <option value="6" ${element.span === 6 ? 'selected' : ''}>6/12 (50%)</option>
                                <option value="7" ${element.span === 7 ? 'selected' : ''}>7/12 (58.3%)</option>
                                <option value="8" ${element.span === 8 ? 'selected' : ''}>8/12 (66.7%)</option>
                                <option value="9" ${element.span === 9 ? 'selected' : ''}>9/12 (75%)</option>
                                <option value="10" ${element.span === 10 ? 'selected' : ''}>10/12 (83.3%)</option>
                                <option value="11" ${element.span === 11 ? 'selected' : ''}>11/12 (91.7%)</option>
                                <option value="12" ${element.span === 12 ? 'selected' : ''}>12/12 (100%)</option>
                            </select>
                        </div>
                    `;
                }

                if (!isLayout) {
                    configHtml += `
                        <div class="config-item">
                            <label class="config-label">å ä½ç¬¦æ–‡æœ¬</label>
                            <input type="text" class="config-input" value="${element.placeholder || ''}" 
                                   onchange="formBuilder.updateElement('placeholder', this.value)">
                        </div>
                        <div class="config-item">
                            <div class="config-checkbox">
                                <input type="checkbox" id="requiredCheck" ${element.required ? 'checked' : ''} 
                                       onchange="formBuilder.updateElement('required', this.checked)">
                                <label for="requiredCheck">å¿…å¡«å­—æ®µ</label>
                            </div>
                        </div>
                    `;

                    if (element.type === 'select' || element.type === 'radio') {
                        configHtml += this.renderOptionsConfig(element);
                    } else if (element.type === 'number') {
                        configHtml += `
                            <div class="config-item">
                                <label class="config-label">æœ€å°å€¼</label>
                                <input type="number" class="config-input" value="${element.min || ''}" 
                                       onchange="formBuilder.updateElement('min', this.value)">
                            </div>
                            <div class="config-item">
                                <label class="config-label">æœ€å¤§å€¼</label>
                                <input type="number" class="config-input" value="${element.max || ''}" 
                                       onchange="formBuilder.updateElement('max', this.value)">
                            </div>
                            <div class="config-item">
                                <label class="config-label">æ­¥é•¿</label>
                                <input type="number" class="config-input" value="${element.step || 1}" 
                                       onchange="formBuilder.updateElement('step', this.value)">
                            </div>
                        `;
                    } else if (element.type === 'textarea') {
                        configHtml += `
                            <div class="config-item">
                                <label class="config-label">è¡Œæ•°</label>
                                <input type="number" class="config-input" value="${element.rows || 4}" min="2" max="20"
                                       onchange="formBuilder.updateElement('rows', parseInt(this.value))">
                            </div>
                        `;
                    }
                }

                configDiv.innerHTML = configHtml;
            }

            renderOptionsConfig(element) {
                const options = element.options || [];
                return `
                    <div class="config-item">
                        <label class="config-label">é€‰é¡¹é…ç½®</label>
                        <div class="options-config">
                            <div id="optionsList">
                                ${options.map((opt, index) => `
                                    <div class="option-item">
                                        <input type="text" class="option-input" value="${opt.label}" 
                                               placeholder="é€‰é¡¹æ–‡æœ¬" onchange="formBuilder.updateOption(${index}, 'label', this.value)">
                                        <input type="text" class="option-input" value="${opt.value}" 
                                               placeholder="é€‰é¡¹å€¼" onchange="formBuilder.updateOption(${index}, 'value', this.value)">
                                        <button class="remove-option" onclick="formBuilder.removeOption(${index})">Ã—</button>
                                    </div>
                                `).join('')}
                            </div>
                            <button class="add-option" onclick="formBuilder.addOption()">+ æ·»åŠ é€‰é¡¹</button>
                        </div>
                    </div>
                `;
            }

            updateElement(property, value) {
                if (this.selectedElement) {
                    this.selectedElement[property] = value;
                    this.render();
                    this.renderElementConfig();
                    this.renderLivePreview();
                }
            }

            updateOption(index, property, value) {
                if (this.selectedElement && this.selectedElement.options) {
                    this.selectedElement.options[index][property] = value;
                    this.render();
                    this.renderLivePreview();
                }
            }

            addOption() {
                if (this.selectedElement && this.selectedElement.options) {
                    this.selectedElement.options.push({ 
                        label: `é€‰é¡¹${this.selectedElement.options.length + 1}`, 
                        value: `option${this.selectedElement.options.length + 1}` 
                    });
                    this.renderElementConfig();
                    this.render();
                }
            }

            removeOption(index) {
                if (this.selectedElement && this.selectedElement.options && this.selectedElement.options.length > 1) {
                    this.selectedElement.options.splice(index, 1);
                    this.renderElementConfig();
                    this.render();
                }
            }

            renderLivePreview() {
                const previewDiv = document.getElementById('livePreview');
                
                if (!this.selectedElement) {
                    previewDiv.innerHTML = '<div class="empty-state">é¢„è§ˆåŒºåŸŸ</div>';
                    return;
                }

                const previewHtml = `
                    <div style="padding: 16px; border: 1px solid #e0e0e0; border-radius: 6px; background: white;">
                        ${this.renderElement(this.selectedElement)}
                    </div>
                `;
                
                previewDiv.innerHTML = previewHtml;
            }

            moveElementUp(elementId) {
                this.moveElement(elementId, -1);
            }

            moveElementDown(elementId) {
                this.moveElement(elementId, 1);
            }

            moveElement(elementId, direction) {
                const parent = this.findParentOfElement(elementId, this.elements);
                const array = parent ? parent.children : this.elements;
                const index = array.findIndex(e => e.id === elementId);
                
                if (index === -1) return;
                
                const newIndex = index + direction;
                if (newIndex >= 0 && newIndex < array.length) {
                    [array[index], array[newIndex]] = [array[newIndex], array[index]];
                    this.render();
                }
            }

            findParentOfElement(elementId, elements, parent = null) {
                for (const element of elements) {
                    if (element.id === elementId) return parent;
                    if (element.children) {
                        const found = this.findParentOfElement(elementId, element.children, element);
                        if (found !== null) return found;
                    }
                }
                return null;
            }

            duplicateElement(elementId) {
                const element = this.findElementById(elementId, this.elements);
                if (!element) return;

                const newElement = JSON.parse(JSON.stringify(element));
                this.updateElementIds(newElement);
                newElement.label = element.label + ' (å‰¯æœ¬)';

                const parent = this.findParentOfElement(elementId, this.elements);
                const array = parent ? parent.children : this.elements;
                const index = array.findIndex(e => e.id === elementId);
                
                array.splice(index + 1, 0, newElement);
                this.render();
            }

            updateElementIds(element) {
                element.id = `element_${this.elementIdCounter++}`;
                if (element.children) {
                    element.children.forEach(child => this.updateElementIds(child));
                }
            }

            removeElement(elementId) {
                const parent = this.findParentOfElement(elementId, this.elements);
                const array = parent ? parent.children : this.elements;
                const index = array.findIndex(e => e.id === elementId);
                
                if (index !== -1) {
                    array.splice(index, 1);
                    if (this.selectedElement && this.selectedElement.id === elementId) {
                        this.selectedElement = null;
                    }
                    this.render();
                    this.renderElementConfig();
                    this.renderLivePreview();
                }
            }

            togglePreview() {
                this.isPreviewMode = !this.isPreviewMode;
                const btn = document.getElementById('previewBtn');
                const previewFormBtn = document.getElementById('previewFormBtn');
                const leftPanel = document.getElementById('leftPanel');
                const rightPanel = document.getElementById('rightPanel');
                
                btn.textContent = this.isPreviewMode ? 'ğŸ”§ ç¼–è¾‘' : 'ğŸ‘€ é¢„è§ˆ';
                btn.classList.toggle('primary', !this.isPreviewMode);
                
                // åˆ‡æ¢é¢æ¿æ˜¾ç¤º
                if (this.isPreviewMode) {
                    leftPanel.style.display = 'none';
                    rightPanel.style.display = 'none';
                    previewFormBtn.style.display = 'inline-block';
                    this.selectElement(null);
                } else {
                    leftPanel.style.display = 'block';
                    rightPanel.style.display = 'block';
                    previewFormBtn.style.display = 'none';
                }
                
                this.render();
            }

            showPreviewForm() {
                // åˆ›å»ºæ–°çª—å£æ˜¾ç¤ºé¢„è§ˆè¡¨å•
                const formHtml = this.generatePreviewFormHTML();
                const newWindow = window.open('', '_blank', 'width=800,height=600');
                if(newWindow){
                    newWindow.document.write(formHtml);
                    newWindow.document.close();
                }
            }

            generatePreviewFormHTML() {
                const formContent = this.renderElements(this.elements);
                
                return `
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¡¨å•é¢„è§ˆ</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 40px;
            background: #f5f5f5;
        }
        .form-container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .form-title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 32px;
            color: #24292f;
        }
        .container-element.row .container-content {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        .container-element.column {
            flex-shrink: 0;
        }
        .container-element.column .container-content {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .col-span-1 { flex: 0 0 calc(8.333% - 10px); }
        .col-span-2 { flex: 0 0 calc(16.666% - 10px); }
        .col-span-3 { flex: 0 0 calc(25% - 10px); }
        .col-span-4 { flex: 0 0 calc(33.333% - 10px); }
        .col-span-5 { flex: 0 0 calc(41.666% - 10px); }
        .col-span-6 { flex: 0 0 calc(50% - 10px); }
        .col-span-7 { flex: 0 0 calc(58.333% - 10px); }
        .col-span-8 { flex: 0 0 calc(66.666% - 10px); }
        .col-span-9 { flex: 0 0 calc(75% - 10px); }
        .col-span-10 { flex: 0 0 calc(83.333% - 10px); }
        .col-span-11 { flex: 0 0 calc(91.666% - 10px); }
        .col-span-12 { flex: 0 0 calc(100% - 10px); }
        .form-field {
            margin-bottom: 0;
        }
        .field-label {
            font-weight: 500;
            margin-bottom: 8px;
            color: #24292f;
        }
        .field-input, .field-select, .field-textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d0d7de;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
        }
        .field-textarea {
            resize: vertical;
        }
        .field-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .submit-bar {
            margin-top: 32px;
            display: flex;
            gap: 12px;
        }
        .btn {
            padding: 10px 24px;
            border: none;
            border-radius: 6px;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-primary {
            background: #0969da;
            color: white;
        }
        .btn-primary:hover {
            background: #0550ae;
        }
        .btn-secondary {
            background: white;
            color: #24292f;
            border: 1px solid #d0d7de;
        }
        .btn-secondary:hover {
            background: #f6f8fa;
        }
        .result {
            margin-top: 24px;
            padding: 16px;
            background: #f6f8fa;
            border: 1px solid #d0d7de;
            border-radius: 6px;
            display: none;
        }
        .result.show {
            display: block;
        }
        .result pre {
            margin: 0;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
    </style>
</head>
<body>
    <div class="form-container">
        <h1 class="form-title">è¡¨å•é¢„è§ˆ</h1>
        <form id="previewForm">
            ${formContent}
            <div class="submit-bar">
                <button type="submit" class="btn btn-primary">æäº¤è¡¨å•</button>
                <button type="reset" class="btn btn-secondary">é‡ç½®</button>
            </div>
        </form>
        <div class="result" id="result">
            <h3 style="margin-bottom: 12px;">æäº¤çš„æ•°æ®ï¼š</h3>
            <pre id="resultData"></pre>
        </div>
    </div>
    <script>
        document.getElementById('previewForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const data = {};
            
            for (let [key, value] of formData.entries()) {
                if (data[key]) {
                    if (Array.isArray(data[key])) {
                        data[key].push(value);
                    } else {
                        data[key] = [data[key], value];
                    }
                } else {
                    data[key] = value;
                }
            }
            
            document.getElementById('resultData').textContent = JSON.stringify(data, null, 2);
            document.getElementById('result').classList.add('show');
            
            // æ»šåŠ¨åˆ°ç»“æœåŒºåŸŸ
            document.getElementById('result').scrollIntoView({ behavior: 'smooth' });
        });
        
        document.getElementById('previewForm').addEventListener('reset', function() {
            setTimeout(() => {
                document.getElementById('result').classList.remove('show');
            }, 100);
        });
    <\/script>
</body>
</html>
                `;
            }

            clearCanvas() {
                if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å†…å®¹å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
                    this.elements = [];
                    this.selectedElement = null;
                    this.elementIdCounter = 1;
                    this.render();
                    this.renderElementConfig();
                    this.renderLivePreview();
                }
            }

            exportSchema() {
                const schema = {
                    title: 'åŠ¨æ€è¡¨å•',
                    description: 'é€šè¿‡è¡¨å•ç”Ÿæˆå™¨åˆ›å»º',
                    version: '2.0',
                    timestamp: new Date().toISOString(),
                    elements: this.elements
                };

                const dataStr = JSON.stringify(schema, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `form-schema-${Date.now()}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                console.log('Schemaå·²å¯¼å‡º', schema);
            }

            importSchema() {
                document.getElementById('fileInput').click();
            }

            handleFileImport(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const schema = JSON.parse(e.target.result);
                        
                        if (!schema.elements || !Array.isArray(schema.elements)) {
                            throw new Error('æ— æ•ˆçš„Schemaæ ¼å¼ï¼šç¼ºå°‘elementsæ•°ç»„');
                        }

                        this.elements = schema.elements;
                        this.selectedElement = null;
                        
                        const maxId = this.getMaxElementId(this.elements);
                        this.elementIdCounter = maxId + 1;

                        this.render();
                        this.renderElementConfig();
                        this.renderLivePreview();

                        alert(`æˆåŠŸå¯¼å…¥è¡¨å•ï¼å…± ${this.countElements(this.elements)} ä¸ªå…ƒç´ `);
                        
                    } catch (error) {
                        alert('å¯¼å…¥å¤±è´¥ï¼š' + error.message);
                        console.error('å¯¼å…¥Schemaå¤±è´¥ï¼š', error);
                    }
                };
                
                reader.readAsText(file);
                event.target.value = '';
            }

            getMaxElementId(elements) {
                let maxId = 0;
                elements.forEach(element => {
                    const match = element.id.match(/element_(\d+)/);
                    if (match) {
                        maxId = Math.max(maxId, parseInt(match[1]));
                    }
                    if (element.children) {
                        maxId = Math.max(maxId, this.getMaxElementId(element.children));
                    }
                });
                return maxId;
            }

            countElements(elements) {
                let count = elements.length;
                elements.forEach(element => {
                    if (element.children) {
                        count += this.countElements(element.children);
                    }
                });
                return count;
            }
        }

        // åˆå§‹åŒ–è¡¨å•ç”Ÿæˆå™¨
        const formBuilder = new FormBuilder();
        window.formBuilder = formBuilder;

        // é˜»æ­¢é¡µé¢å…¶ä»–åœ°æ–¹çš„æ‹–æ‹½
        document.addEventListener('dragover', (e) => {
            if (!e.target.closest('.drop-zone') && !e.target.closest('.container-content')) {
                e.preventDefault();
            }
        });

        document.addEventListener('drop', (e) => {
            if (!e.target.closest('.drop-zone') && !e.target.closest('.container-content')) {
                e.preventDefault();
            }
        });

        console.log('âœ… åŠ¨æ€è¡¨å•ç”Ÿæˆå™¨ Pro v2.1 å·²åˆå§‹åŒ–');
        console.log('ğŸ“ å¸ƒå±€ç³»ç»Ÿ: Row (è‡ªåŠ¨æ¢è¡Œ) > Column (å‚ç›´æ’åˆ—) > è¡¨å•ç»„ä»¶');
        console.log('ğŸ¯ æ …æ ¼ç³»ç»Ÿ: 12åˆ—å¸ƒå±€ï¼ŒColumnæ”¯æŒ1-12åˆ—å®½');
        console.log('ğŸ¨ é¢„è§ˆæ¨¡å¼: ä¿ç•™è¾“å…¥å€¼ï¼Œæ”¯æŒè¡¨å•æäº¤');
        console.log('');
        console.log('ä½¿ç”¨åœºæ™¯ç¤ºä¾‹ï¼š');
        console.log('1. ä¸¤åˆ—å¸ƒå±€: Row > Column(6) + Column(6)');
        console.log('2. ä¸‰åˆ—å¸ƒå±€: Row > Column(4) + Column(4) + Column(4)');
        console.log('3. ä¾§è¾¹æ å¸ƒå±€: Row > Column(3) + Column(9)');
        console.log('4. è‡ªåŠ¨æ¢è¡Œ: Row > Column(4) + Column(4) + Column(4) + Column(6) [å‰3ä¸ªä¸€è¡Œï¼Œæœ€åä¸€ä¸ªæ¢è¡Œ]');
    </script>
</body>
</html>